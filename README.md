# Отчёт по домашнему заданию: регрессия цен автомобилей и Streamlit-сервис

## 1. Что было сделано

### 1.1. Подготовка данных и EDA

- Загрузка и первичная очистка данных:
  - обработка пропусков и некорректных значений;
  - явное приведение типов для числовых и категориальных признаков.
- Анализ распределения целевой переменной `selling_price`:
  - исходное распределение оказалось сильно правосторонним, с заметными выбросами;
  - применено логарифмирование `log_price = log1p(selling_price)`, что сделало распределение ближе к нормальному и уменьшило влияние экстремальных значений.
- Исследование связи признаков с ценой:
  - построены scatter-графики (год выпуска, пробег, мощность, объём, расход и др.) против `log_price`;
  - построены boxplot-ы `log_price` по категориям: марка (укрупнённые бренды), тип топлива, тип трансмиссии, тип продавца, количество владельцев;
  - рассчитаны корреляции числовых признаков с `log_price`.

### 1.2. Инженерия признаков

Для каждого объекта были добавлены новые признаки:

- `age` — возраст автомобиля: `CURRENT_YEAR - year`;
- `km_per_year` — пробег в год: `km_driven / max(age, 1)`;
- `log_km_driven` — логарифм пробега: `log1p(km_driven)`;
- `power_per_litre` — удельная мощность: `max_power / engine`;
- `torque_per_litre` — удельный крутящий момент: `torque / engine`.

Обработка категориальных признаков:

- столбец `name` преобразован в «бренд» (первое слово в названии);
- редкие бренды (ниже порога по частоте) объединены в категорию `Other`;
- категориальные признаки `name`, `fuel`, `seller_type`, `transmission`, `owner`, `seats` закодированы методом One-Hot;
- один столбец из каждой OHE-группы фактически играет роль базовой категории (во избежание мультиколлинеарности).

### 1.3. Модели и обучение

Были обучены и сравнены следующие варианты линейных моделей:

1. **Базовая линейная регрессия по исходным числовым признакам (без OHE).**
2. **Линейная регрессия по полному набору признаков (числовые + OHE), таргет = `selling_price`.**
3. **Lasso-регрессия (L1) по стандартизированным признакам.**
4. **ElasticNet (L1 + L2) с подбором `alpha` и `l1_ratio` по GridSearchCV.**
5. **Ridge-регрессия (L2) с подбором `alpha` по GridSearchCV.**
6. **Самодельная модель с L0-регуляризацией (по сути, пороговая обрезка малых коэффициентов).**
7. **Финальная модель:** линейная регрессия по **логарифму цены** `log_price` на полном наборе стандартизированных признаков.

Общий pipeline для финальной модели:

1. генерация новых признаков;
2. One-Hot-кодирование категориальных признаков;
3. приведение к фиксированному набору колонок;
4. стандартизация (StandardScaler);
5. LinearRegression по `log_price`;
6. обратное преобразование прогноза: `pred_price = expm1(pred_log_price)`.

### 1.4. Метрики качества и бизнес-метрики

Для всех моделей считались:

- **R²** на train и test;
- **MSE в рублях** на train и test;
- **бизнес-метрика №1** — доля объектов, у которых прогноз отличается от реальной цены не более чем на ±10%;
- **бизнес-метрика №2** — модифицированная метрика (weighted business metric), которая сильнее штрафует **недопрогноз** (слишком низкую цену) и мягче относится к перепрогнозу.

Все метрики считались как для обычной модели по `selling_price`, так и для модели по `log_price` (после обратного преобразования к рублям).

### 1.5. Streamlit-приложение

Разработано интерактивное веб-приложение на Streamlit с тремя основными страницами:

1. **EDA**
   - Загрузка CSV-файла с признаками.
   - Автоматическое построение:
     - гистограмм выбранного числового признака (по умолчанию `log_price`, если есть цена);
     - интерактивных scatter-графиков (с выбором осей и окраской по категориальному признаку);
     - boxplot-ов `log_price` по выбранной категории (Top-10 брендов + `Other` для `name`);
     - столбчатого графика корреляций с `log_price` или тепловой карты корреляций числовых признаков (если таргета нет).
2. **Прогнозы**
   - Применение модели ко всему загруженному датасету:
     - добавляются столбцы `pred_price` и, при наличии `selling_price`, относительная ошибка;
   - режим ручного ввода признаков одного автомобиля и моментальный расчёт цены.
3. **Коэффициенты**
   - Визуализация коэффициентов модели по признакам:
     - фильтр по типу признаков (числовые / категориальные / все);
     - выбор количества топ-признаков по величине коэффициента;
     - горизонтальный bar-chart, таблица коэффициентов и модулей коэффициентов;
     - текстовая интерпретация влияния признаков на `log_price`.

---

## 2. Полученные результаты и интерпретация

(Числа могут немного отличаться в зависимости от случайности и версии данных, здесь приведены ориентировочные значения.)

### 2.1. Модели по исходной цене

- Базовая линейная регрессия по числовым признакам показала:
  - R²_test порядка **0.48–0.50**;
  - MSE_test порядка **1.5·10¹¹**.
- Добавление OHE-признаков и нормализации улучшило результат:
  - R²_test ≈ **0.73**;
  - MSE_test ≈ **1.5·10¹¹** (ошибка всё ещё заметно велика из-за выбросов и асимметрии распределения).

Lasso, ElasticNet и Ridge помогали немного стабилизировать модель, но принципиального скачка качества не давали. L1-регуляризация практически не зануляла признаки, что говорит о том, что все использованные признаки несут некоторую информацию.

### 2.2. Модель по логарифму цены (финальная)

При переходе к таргету `log_price` и обратному преобразованию к рублям:

- R²_train (по логам) ≈ **0.88**;
- R²_test (по логам) ≈ **0.91**;
- MSE_train (в рублях) ≈ **3.3·10¹⁰**;
- MSE_test (в рублях) ≈ **7.2·10¹⁰**.

По сравнению с моделью по `selling_price`:

- R² на тесте вырос с ~0.73 до ~0.91 в лог-шкале;
- MSE_test в рублях примерно в **2 раза ниже**, чем у лучшей модели по исходной цене;
- распределение ошибок стало симметричнее, крупных катастрофических промахов стало меньше.

### 2.3. Бизнес-метрики

- **Доля прогнозов в коридоре ±10%** от реальной цены:
  - базовые модели по `selling_price`: ~0.25–0.28;
  - финальная модель по `log_price`: ~0.35–0.37.
- **Weighted business metric** (с дополнительным штрафом за недопрогноз):
  - лучшее значение также показала модель по `log_price`;
  - модели c регуляризацией (ElasticNet, Lasso, Ridge) немного уступили по бизнес-метрикам, несмотря на сопоставимые R².

Итого, по всем типам метрик (R², MSE, бизнес-метрики) лидирует модель линейной регрессии по логарифму цены.

---

## 3. Что дало наибольший прирост качества

1. **Переход к таргету `log(selling_price)`**
   - сгладил выбросы и правый тяжёлый хвост распределения;
   - сделал зависимость «признак → цена» ближе к линейной;
   - существенно снизил MSE в рублях после обратного преобразования.

2. **Инженерия признаков**
   - использование `age`, `km_per_year`, `power_per_litre`, `torque_per_litre` позволило лучше описывать техническое состояние и «силовой потенциал» автомобиля;
   - эти признаки вошли в число наиболее значимых по модулю коэффициентов модели.

3. **One-Hot-кодирование категориальных признаков**
   - позволило учесть различия по брендам, типам топлива, типу коробки передач и типу продавца;
   - бренд и тип топлива оказались важными факторами для цены.

---

## 4. Что сделать не удалось и почему

- **Полностью избавиться от влияния выбросов.**  
  Логарифмирование заметно помогло, но в данных всё ещё присутствуют автомобили с аномально высокими или низкими ценами и пробегами, которые трудно описать линейной моделью.
- **Добиться значимой разреженности (зануления коэффициентов) с помощью Lasso.**  
  Из-за относительно небольшого числа признаков и их полезности для задачи L1-регуляризация не обнуляла веса даже при достаточно больших значениях `alpha`, а сильное увеличение `alpha` уже приводило к деградации качества.
- **Построить сильно более качественную модель с ElasticNet/Ridge по сравнению с «простой» линейной регрессией.**  
  Регуляризация помогала стабилизировать модель, но явных выигрышей по MSE и бизнес-метрикам не давала.

---

## 5. Оценка разработанного сервиса

### 5.1. Удобство использования

- Приложение запускается одной командой `streamlit run app.py`.
- Навигация разделена на три понятные вкладки: EDA, Прогнозы, Коэффициенты.
- Поддерживаются два сценария:
  - загрузка CSV-файла с пачкой автомобилей;
  - ручной ввод параметров одного автомобиля.
- Прогнозы отображаются сразу, без необходимости разбираться в коде или ноутбуке.

В целом сервис удобен для пользователя, который умеет подготовить CSV-файл с нужными колонками.

### 5.2. Визуализации: что получилось хорошо, а что — менее удачно

**Удачно:**

- интерактивные графики на Plotly (histogram, scatter, boxplot, корреляции);
- возможность выбирать оси, категориальный признак для окраски, фильтровать по типу признаков;
- на странице коэффициентов удобно анализировать важность признаков и их эффект на `log(price)`.

**Менее удачно / спорные места:**

- при очень большом числе строк scatter-графики могут становиться тяжёлыми по рендерингу;
- пользователю нужно знать, какие именно колонки должны быть в CSV (нет отдельного «шаблона» внутри приложения);
- визуализация бизнес-метрик пока не вынесена в отдельную страницу, они считаются только офлайн в ноутбуке.

### 5.3. Ограничения и замеченные проблемы

- Сервис ориентирован на ту же структуру признаков, что и обучающая выборка; если структура сильно изменится, модель работать не будет.
- Модель линейная — она хорошо интерпретируема, но может не ловить нелинейные эффекты и сложные взаимодействия признаков.
- Нет учёта инфляции/временного фактора на уровне данных (год выпуска учитывается, но не год продажи).
- Валидация корректности входных данных (например, отрицательные пробеги) минимальна.

### 5.4. Планируемые улучшения

- Добавить в приложение:
  - отображение основных метрик качества по загруженному датасету (R², MSE, бизнес-метрика);
  - отдельный блок с бизнес-метриками и сравнение с «бенчмарком».
- Реализовать сохранение результатов прогноза в CSV прямо из интерфейса.
- Добавить шаблон CSV и краткую справку по колонкам.
- Попробовать более сложные модели (например, Gradient Boosting / Random Forest / CatBoost) и сравнить их с линейной моделью по R², MSE и бизнес-метрикам.
- Расширить обработку временных эффектов (например, зависимость цены от года продажи / периода рынка).

---
